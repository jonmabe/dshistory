// dsHistory, v.9
// Copyright (c) 2007 Andrew Mattie (http://www.akmattie.net)
//
// Permission is hereby granted, free of charge, to any person obtaining
// a copy of this software and associated documentation files (the
// "Software"), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to
// permit persons to whom the Software is furnished to do so, subject to
// the following conditions:
// 
// The above copyright notice and this permission notice shall be
// included in all copies or substantial portions of the Software.

var dsHistory={isIE:window.navigator.userAgent.indexOf("MSIE")!==-1,QueryElements:{},lastFrameIteration:0,lastHash:"",dirtyHash:window.location.hash,initialHash:window.location.hash,hashCache:[],forwardHashCache:[],eventCache:[],forwardEventCache:[],isInHistory:false,pauseWatch:false,initialize:function(_1){var i,historyFrame;historyFrame=document.createElement("iframe");historyFrame.name="dsHistoryFrame";historyFrame.id="dsHistoryFrame";historyFrame.src="dshistory.html?0";historyFrame.style.display="none";document.body.appendChild(historyFrame);this.frameWindow=window.frames["dsHistoryFrame"];this.frameObject=historyFrame;if(this.isIE){this.hashCache.push(window.location.hash);}this.watcherInterval=window.setInterval(function(){dsHistory._frameWatcher();},15);this._loadQueryVars();if(_1){_1();}if(window.addEventListener){window.addEventListener("unload",this._unload,false);}else{if(window.attachEvent){window.attachEvent("onunload",this._unload);}}},addFunction:function(_3){this.pauseWatch=true;this.isInHistory=false;this.forwardEventCache=[];this.forwardHashCache=[];if(!this.isIE&&this.hashCache.length==1&&this.eventCache.length==1&&(window.location.hash==""||window.location.hash=="#")){window.history.forward();}if(this.isIE){this.hashCache.push(window.location.hash);}this.eventCache.push(_3);this._updateFrameIteration();this.pauseWatch=false;},setQueryVar:function(_4,_5){var _6=String(_4);var _7=String(((typeof _5=="undefined")?"":_5));if(this.dirtyHash.indexOf("#")==-1||this.dirtyHash.indexOf("#_serial")==0){if(_7!=""){this.dirtyHash="#"+_6+"="+_7;}else{this.dirtyHash="#"+_6;}}else{if(typeof this.QueryElements[_6]!="undefined"&&_7!=""){this.dirtyHash=this.dirtyHash.substr(0,this.dirtyHash.indexOf(_6)+_6.length+1)+_7+this.dirtyHash.substr(this.dirtyHash.indexOf(_6)+_6.length+1+this.QueryElements[_6].length);}else{if(typeof this.QueryElements[_6]=="undefined"){if(_7==""){this.dirtyHash+="&"+_6;}else{this.dirtyHash+="&"+_6+"="+_7;}}}}this.QueryElements[_4]=_5;if(this.hashCache>1&&this.hashCache[this.hashCache.length-2]==this.dirtyHash){this.dirtyHash+="_serial="+this.hashCache.length;}else{if(this.dirtyHash.indexOf("_serial")!=-1){this.removeQueryVar("_serial");}}},removeQueryVar:function(_8){if(!this.QueryElements[_8]&&_8!="_serial"){return;}var _9;if(this.QueryElements[_8]==""){_9=_8;}else{_9=_8+"="+this.QueryElements[_8];}this.dirtyHash=this.dirtyHash.substr(0,this.dirtyHash.indexOf(_9))+this.dirtyHash.substr(this.dirtyHash.indexOf(_9)+_9.length);if(this.dirtyHash.substr(this.dirtyHash.length-1)=="&"){this.dirtyHash=this.dirtyHash.substr(0,this.dirtyHash.length-1);}if(this.dirtyHash.indexOf("#&")==0){this.dirtyHash="#"+this.dirtyHash.substr(2);}delete (this.QueryElements[_8]);if(this.dirtyHash=="#"){this.dirtyHash="#_serial="+this.hashCache.length;}},bindQueryVars:function(_a){if(window.location.hash==this.dirtyHash){return;}this.pauseWatch=true;this.isInHistory=false;this.forwardEventCache=[];this.forwardHashCache=[];if(!this.isIE&&this.hashCache.length==1&&this.eventCache.length==1&&(window.location.hash==""||window.location.hash=="#")){window.history.forward();}if(this.hashCache.length==0&&this.eventCache.length>0&&!this.isIE){this.hashCache.push(window.location.hash);}window.location.hash=this.dirtyHash;this.lastHash=window.location.hash;this.hashCache.push(this.lastHash);this.eventCache.push(_a);if(this.isIE){this._updateFrameIteration(true);}this._loadQueryVars();this.pauseWatch=false;},setFirstEvent:function(_b){if(this.eventCache.length>0){this.eventCache[0]=_b;}},_unload:function(){window.clearInterval(dsHistory.watcherInterval);dsHistory.frameWindow=null;dsHistory.frameObject=null;dsHistory.eventCache=null;},_loadQueryVars:function(){this.QueryElements={};if(window.location.hash==""||window.location.hash=="#"){return;}var _c=window.location.hash.substring(1).split("&");for(i=0;i<_c.length;i++){if(_c[i].indexOf("=")!=-1){this.QueryElements[_c[i].split("=")[0]]=_c[i].split("=")[1];}else{this.QueryElements[_c[i]]="";}}this.lastHash=window.location.hash;},_updateFrameIteration:function(_d){var _e=this.frameWindow.document.body.innerHTML;var _f=parseInt(_e.substr(_e.indexOf("?")+1));var _10,newEvent,lastHash;if(this.hashCache.length>0&&!this.isIE){_10=this.eventCache.splice(this.eventCache.length-1,1)[0];lastHash=this.lastHash;if(lastHash==""){lastHash="#";}window.location.hash=lastHash+String(this.hashCache.length);this.hashCache.push(window.location.hash);window.location.hash=lastHash;this.hashCache.push(window.location.hash);this.eventCache.push(function(_11){if(_11=="back"){dsHistory.isGoingBackward=true;window.history.back();}else{dsHistory.isGoingForward=true;window.history.forward();}});this.eventCache.push(_10);return;}if(_f==0&&((this.hashCache.length==(_d?1:0)&&!this.isIE)||(this.hashCache.length==2&&this.isIE))&&this.eventCache.length<=1){this.frameWindow.document.body.innerHTML=_e.substr(0,_e.indexOf("?"))+"?1";}else{this.frameObject.src=_e.substr(0,_e.indexOf("?"))+"?"+(_f+1);}},_frameWatcher:function(){if(!this.frameWindow.document.body){return;}var _12=this.frameWindow.document.body.innerHTML;var _13=parseInt(_12.substr(_12.indexOf("?")+1));var _14=window.location.hash;if(this.pauseWatch){return;}if(this.isInHistory&&this.hashCache.length>1&&window.location.hash==this.hashCache[0]&&this.dirtyHash!=this.initialHash){this.dirtyHash=this.initialHash;}if(!this.isGoingForward&&(_13<this.lastFrameIteration||(this.lastHash!=_14&&this.hashCache[this.hashCache.length-2]==_14&&!this.isIE))){this.isInHistory=true;this.isGoingBackward=false;if((this.lastHash!=_14&&this.hashCache[this.hashCache.length-2]==_14)||this.isIE){this.forwardHashCache=this.forwardHashCache.concat(this.hashCache.splice(this.hashCache.length-1,1));if(this.isIE){window.location.hash=this.hashCache[this.hashCache.length-1];}this.lastHash=window.location.hash;this.dirtyHash=window.location.hash;}if(this.eventCache.length>1){this.eventCache[this.eventCache.length-2]("back");this.forwardEventCache=this.forwardEventCache.concat(this.eventCache.splice(this.eventCache.length-1,1));}}else{if(this.isInHistory&&!this.isGoingBackward&&(_13>this.lastFrameIteration||(this.lastHash!=_14&&this.forwardHashCache[this.forwardHashCache.length-1]==_14&&!this.isIE))){this.isGoingForward=false;if((this.lastHash!=_14&&this.forwardHashCache[this.forwardHashCache.length-1]==_14)||this.isIE){if(this.isIE){window.location.hash=this.forwardHashCache[this.forwardHashCache.length-1];}this.lastHash=window.location.hash;this.dirtyHash=window.location.hash;this.hashCache=this.hashCache.concat(this.forwardHashCache.splice(this.forwardHashCache.length-1,1));}this.forwardEventCache[this.forwardEventCache.length-1]("forward");this.eventCache=this.eventCache.concat(this.forwardEventCache.splice(this.forwardEventCache.length-1,1));}}this.lastFrameIteration=_13;}};